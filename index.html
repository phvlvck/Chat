<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        
        .login-box {
            max-width: 400px; margin: 50px auto; padding: 30px;
            background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        .chat-box {
            max-width: 800px; margin: 20px auto; background: white;
            border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
        }
        
        .header { background: linear-gradient(to right, #667eea, #764ba2); color: white; padding: 20px; }
        .rooms { width: 200px; background: #f8f9fa; border-right: 1px solid #ddd; }
        .room { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .room.active { background: #667eea; color: white; }
        .messages { flex: 1; padding: 20px; height: 400px; overflow-y: auto; }
        .message { margin: 10px 0; padding: 10px 15px; border-radius: 15px; max-width: 70%; }
        .message.own { background: #667eea; color: white; margin-left: auto; }
        .message.other { background: #f1f1f1; color: #333; }
        .input-area { padding: 20px; background: #f8f9fa; border-top: 1px solid #ddd; }
        input { width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 25px; font-size: 16px; }
        button { background: #667eea; color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; }
        
        @media (max-width: 768px) {
            .chat-box { flex-direction: column; }
            .rooms { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginBox" class="login-box">
        <h2>ğŸš€ Ø¯Ø±Ø¯Ø´Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©</h2>
        <p style="margin: 20px 0; color: #666;">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</p>
        <input type="text" id="username" placeholder="Ø§Ø³Ù…Ùƒ..." style="width:100%; padding:15px; margin:10px 0;">
        <button onclick="login()" style="width:100%; padding:15px; margin-top:20px;">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©</button>
        <div id="status" style="margin-top:20px; color:#666; font-size:14px;">
            ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...
        </div>
    </div>

    <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
    <div id="chatBox" class="chat-box">
        <div class="header">
            <h3>ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©</h3>
            <p id="welcomeMsg">Ù…Ø±Ø­Ø¨Ø§Ù‹!</p>
        </div>
        
        <div style="display:flex; min-height:500px;">
            <!-- Ø§Ù„ØºØ±Ù -->
            <div class="rooms" id="roomsList">
                <!-- Ø§Ù„ØºØ±Ù ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±ÙŠØ¨Øª -->
            </div>
            
            <!-- Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
            <div style="flex:1; display:flex; flex-direction:column;">
                <div class="messages" id="messages">
                    <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
                </div>
                
                <div class="input-area">
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." onkeypress="handleKeyPress(event)">
                        <button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        // ğŸ”§ âš ï¸ âš ï¸ âš ï¸ âš ï¸ âš ï¸ âš ï¸ âš ï¸ âš ï¸ âš ï¸ âš ï¸ âš ï¸ âš ï¸
        // Ø¶Ø¹ Ù‡Ù†Ø§ Ø¹Ù†ÙˆØ§Ù† IP Ù„Ø³ÙŠØ±ÙØ±Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ
        // Ù…Ø«Ø§Ù„: http://192.168.1.100:5000
        const SERVER_URL = 'http://YOUR_PHONE_IP_HERE:5000';
        // âš ï¸ âš ï¸ âš ï¸ âš ï¸ âš ï¸ âš ï¸ âš ï¸ âš ï¸ âš ï¸ âš ï¸ âš ï¸ âš ï¸ âš ï¸
        
        let socket = null;
        let currentUser = null;
        let currentRoom = 'general';
        
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        document.getElementById('status').innerHTML = `ğŸ“¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€: ${SERVER_URL}`;
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        function login() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            document.getElementById('status').innerHTML = 'ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';
            
            // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±
            socket = io(SERVER_URL, {
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionAttempts: 10
            });
            
            // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø³ÙˆÙƒÙŠØª
            socket.on('connect', () => {
                console.log('âœ… Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±');
                document.getElementById('status').innerHTML = 'âœ… Ù…ØªØµÙ„ - Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';
                
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                socket.emit('register', { username: username });
            });
            
            socket.on('connected', (data) => {
                console.log('ğŸ‰ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ:', data);
            });
            
            socket.on('registered', (data) => {
                console.log('âœ… Ù…Ø³Ø¬Ù„:', data);
                currentUser = { id: data.user_id, username: data.username };
                
                // Ø¥Ø®ÙØ§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
                document.getElementById('loginBox').style.display = 'none';
                document.getElementById('chatBox').style.display = 'block';
                document.getElementById('welcomeMsg').innerHTML = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${data.username}!`;
                
                // Ø¹Ø±Ø¶ Ø§Ù„ØºØ±Ù
                updateRooms(data.rooms);
                
                // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                joinRoom('general');
            });
            
            socket.on('room_joined', (data) => {
                console.log('ğŸšª Ø§Ù†Ø¶Ù…Ù…Øª Ù„Ù„ØºØ±ÙØ©:', data);
                currentRoom = data.room;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                document.getElementById('welcomeMsg').innerHTML = 
                    `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.username} - ${data.room_name} (${data.members} Ø£Ø¹Ø¶Ø§Ø¡)`;
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                showMessages(data.messages);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØºØ±Ù Ø§Ù„Ù†Ø´Ø·Ø©
                updateActiveRoom(data.room);
            });
            
            socket.on('new_message', (data) => {
                if (data.room === currentRoom) {
                    addMessage(data);
                }
            });
            
            socket.on('room_update', (data) => {
                if (data.room === currentRoom) {
                    document.getElementById('welcomeMsg').innerHTML = 
                        `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.username} - ${rooms[currentRoom]?.name || currentRoom} (${data.members} Ø£Ø¹Ø¶Ø§Ø¡)`;
                }
                updateRoomsList();
            });
            
            socket.on('user_joined', (data) => {
                console.log('ğŸ‘¤ Ø§Ù†Ø¶Ù…:', data);
                showNotification(`${data.username} Ø§Ù†Ø¶Ù… Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©`);
            });
            
            socket.on('error', (data) => {
                alert('âŒ Ø®Ø·Ø£: ' + data.message);
            });
            
            socket.on('connect_error', (error) => {
                document.getElementById('status').innerHTML = 
                    `âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„. ØªØ£ÙƒØ¯ Ù…Ù†:<br>
                    1. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ<br>
                    2. Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµØ­ÙŠØ­: ${SERVER_URL}<br>
                    3. Ù†ÙØ³ Ø§Ù„Ø´Ø¨ÙƒØ© Wi-Fi`;
                console.error('âŒ Ø®Ø·Ø£ Ø§ØªØµØ§Ù„:', error);
            });
        }
        
        // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ©
        function joinRoom(roomId) {
            if (currentUser) {
                socket.emit('join_room', {
                    room_id: roomId,
                    user_id: currentUser.id
                });
            }
        }
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message && socket && currentUser) {
                socket.emit('send_message', {
                    room_id: currentRoom,
                    user_id: currentUser.id,
                    message: message
                });
                input.value = '';
            }
        }
        
        // Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        function showMessages(messages) {
            const container = document.getElementById('messages');
            container.innerHTML = '';
            
            messages.forEach(msg => {
                addMessage(msg, false);
            });
            
            // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„
            container.scrollTop = container.scrollHeight;
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø©
        function addMessage(data, scroll = true) {
            const container = document.getElementById('messages');
            const isOwn = data.user_id === currentUser?.id;
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${isOwn ? 'own' : 'other'}`;
            msgDiv.innerHTML = `
                <div style="font-weight:bold; margin-bottom:5px;">${data.username}</div>
                <div>${data.message}</div>
                <div style="font-size:12px; opacity:0.7; margin-top:5px;">${data.time}</div>
            `;
            
            container.appendChild(msgDiv);
            
            if (scroll) {
                container.scrollTop = container.scrollHeight;
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØºØ±Ù
        function updateRooms(roomsList) {
            window.rooms = {};
            roomsList.forEach(room => {
                window.rooms[room.id] = room;
            });
            updateRoomsList();
        }
        
        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØºØ±Ù
        function updateRoomsList() {
            const container = document.getElementById('roomsList');
            container.innerHTML = '';
            
            for (const roomId in window.rooms) {
                const room = window.rooms[roomId];
                const roomDiv = document.createElement('div');
                roomDiv.className = `room ${roomId === currentRoom ? 'active' : ''}`;
                roomDiv.innerHTML = `
                    <div style="font-weight:bold;">${room.name}</div>
                    <div style="font-size:12px; opacity:0.8;">${room.members} Ø£Ø¹Ø¶Ø§Ø¡</div>
                `;
                roomDiv.onclick = () => joinRoom(roomId);
                container.appendChild(roomDiv);
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ù†Ø´Ø·Ø©
        function updateActiveRoom(roomId) {
            const roomDivs = document.querySelectorAll('.room');
            roomDivs.forEach(div => {
                div.classList.remove('active');
            });
            
            const activeDiv = document.querySelector(`.room[onclick*="${roomId}"]`);
            if (activeDiv) {
                activeDiv.classList.add('active');
            }
        }
        
        // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±
        function showNotification(text) {
            console.log('ğŸ“¢', text);
        }
    </script>
</body>
</html>                    `;
                    roomItem.onclick = () => this.joinRoom(roomId);
                    roomsList.appendChild(roomItem);
                }
            }
            
            updateActiveRoom(roomId) {
                const roomItems = document.querySelectorAll('.room-item');
                roomItems.forEach(item => {
                    item.classList.remove('active');
                    if (item.querySelector('.room-name').textContent === this.rooms[roomId]?.name) {
                        item.classList.add('active');
                    }
                });
            }
            
            displayMessages(messages) {
                const container = document.getElementById('messagesContainer');
                container.innerHTML = '';
                
                messages.forEach(msg => {
                    this.addMessage(msg, false);
                });
                
                container.scrollTop = container.scrollHeight;
            }
            
            addMessage(data, scroll = true) {
                const container = document.getElementById('messagesContainer');
                
                // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
                const welcomeMsg = container.querySelector('.welcome-message');
                if (welcomeMsg) welcomeMsg.remove();
                
                const messageDiv = document.createElement('div');
                const isOwnMessage = data.sender_id === this.user?.id;
                messageDiv.className = `message ${isOwnMessage ? 'sent' : 'received'}`;
                
                const time = new Date(data.timestamp).toLocaleTimeString('ar-EG', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                messageDiv.innerHTML = `
                    <div class="message-sender">${data.sender}</div>
                    <div class="message-content">${data.message}</div>
                    <div class="message-time">${time}</div>
                `;
                
                container.appendChild(messageDiv);
                
                if (scroll) {
                    container.scrollTop = container.scrollHeight;
                }
            }
            
            showNotification(message) {
                console.log('ğŸ“¢', message);
                // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø© Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù‡Ù†Ø§
            }
            
            disconnect() {
                if (this.socket) {
                    this.socket.disconnect();
                }
                this.socket = null;
                this.user = null;
                this.connected = false;
            }
        }
        
        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const app = new ChatApp();
    </script>
</body>
</html>
