<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ</title>
    <style>
        /* CSS Ø§Ù„Ø³Ø§Ø¨Ù‚ ÙƒØ§Ù…Ù„Ø§Ù‹ Ù‡Ù†Ø§ */
        /* (Ø§Ø­ØªÙØ¸ Ø¨Ù†ÙØ³ ÙƒÙˆØ¯ CSS Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„) */
    </style>
</head>
<body>
    <div id="app">
        <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
    </div>

    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
        // ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±Ú¤Ø±
        const SERVER_URL = 'http://localhost:5000'; // Ø£Ùˆ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³ÙŠØ±Ú¤Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        class ChatApp {
            constructor() {
                this.socket = null;
                this.user = null;
                this.currentRoom = 'general';
                this.rooms = {};
                this.connected = false;
                
                this.init();
            }
            
            init() {
                this.renderLogin();
                this.bindEvents();
            }
            
            renderLogin() {
                document.getElementById('app').innerHTML = `
                    <div class="login-section">
                        <h1>ğŸ’¬ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ</h1>
                        <p>Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„ØªØ¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†</p>
                        
                        <form id="loginForm" class="login-form">
                            <input type="text" id="usernameInput" class="form-input" 
                                   placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§" required maxlength="20" autofocus>
                            <button type="submit" class="login-btn">ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</button>
                        </form>
                        
                        <div style="margin-top: 30px; color: #6c757d; font-size: 0.9rem;">
                            <p>ğŸ”— Ù…ØªØµÙ„ Ø¨Ø³ÙŠØ±Ú¤Ø±: ${SERVER_URL}</p>
                            <p>ğŸ‘¥ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ ØºØ±Ù Ù…Ø®ØªÙ„ÙØ© ÙˆØ§Ù„ØªØ­Ø¯Ø« Ù…Ø¹ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø­Ù‚ÙŠÙ‚ÙŠÙŠÙ†</p>
                        </div>
                    </div>
                `;
            }
            
            renderChat() {
                document.getElementById('app').innerHTML = `
                    <div class="container">
                        <header>
                            <h1>ğŸ’¬ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ</h1>
                            <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ ${this.user.username} | Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</p>
                        </header>
                        
                        <div class="app-body">
                            <!-- Ù‚Ø³Ù… Ø§Ù„ØºØ±Ù -->
                            <div class="rooms-section">
                                <div class="rooms-list">
                                    <h3>ğŸ“ Ø§Ù„ØºØ±Ù Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
                                    <div id="roomsList"></div>
                                </div>
                            </div>
                            
                            <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
                            <div class="chat-section">
                                <div class="chat-header">
                                    <h3 id="currentRoom">Ø§Ù„ØºØ±ÙØ©: Ø¹Ø§Ù…</h3>
                                    <div class="online-count">
                                        <span id="onlineCount">0</span> Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†
                                    </div>
                                </div>
                                
                                <div class="messages-container" id="messagesContainer">
                                    <div class="welcome-message">
                                        <p style="text-align: center; color: #6c757d; padding: 20px;">
                                            Ù…Ø±Ø­Ø¨Ø§Ù‹ ${this.user.username}! Ø§Ø®ØªØ± ØºØ±ÙØ© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.
                                        </p>
                                    </div>
                                </div>
                                
                                <div class="input-section">
                                    <form id="messageForm" class="message-form">
                                        <input type="text" id="messageInput" class="message-input" 
                                               placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." autocomplete="off" dir="rtl">
                                        <button type="submit" class="send-btn">Ø¥Ø±Ø³Ø§Ù„</button>
                                    </form>
                                </div>
                            </div>
                            
                            <!-- Ù‚Ø³Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
                            <div class="user-section">
                                <div class="user-profile">
                                    <div class="avatar" id="userAvatar">
                                        ${this.user.username[0].toUpperCase()}
                                    </div>
                                    <div class="user-info">
                                        <h3 id="displayUsername">${this.user.username}</h3>
                                        <p id="userStatus">ğŸŸ¢ Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</p>
                                        <p style="font-size: 0.8rem; color: #6c757d;">ID: ${this.user.id}</p>
                                    </div>
                                </div>
                                
                                <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid #dee2e6;">
                                    <button id="logoutBtn" style="width: 100%; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;">
                                        ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                this.updateRoomsList();
                this.bindChatEvents();
            }
            
            bindEvents() {
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                document.addEventListener('submit', (e) => {
                    if (e.target.id === 'loginForm') {
                        e.preventDefault();
                        const username = document.getElementById('usernameInput').value.trim();
                        if (username) {
                            this.connectToServer(username);
                        }
                    }
                });
            }
            
            bindChatEvents() {
                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                document.getElementById('messageForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const input = document.getElementById('messageInput');
                    const message = input.value.trim();
                    
                    if (message && this.currentRoom) {
                        this.socket.emit('send_message', {
                            room_id: this.currentRoom,
                            message: message
                        });
                        input.value = '';
                        input.focus();
                    }
                });
                
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                        this.disconnect();
                        this.renderLogin();
                    }
                });
                
                // Ø§Ø®ØªØµØ§Ø± Enter Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                document.getElementById('messageInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        document.getElementById('messageForm').dispatchEvent(new Event('submit'));
                    }
                });
            }
            
            connectToServer(username) {
                console.log('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±Ú¤Ø±...');
                
                // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±Ú¤Ø±
                this.socket = io(SERVER_URL, {
                    transports: ['websocket', 'polling'],
                    reconnection: true,
                    reconnectionAttempts: 5,
                    reconnectionDelay: 1000
                });
                
                // Ø£Ø­Ø¯Ø§Ø« Socket.IO
                this.socket.on('connect', () => {
                    console.log('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±Ú¤Ø±');
                    this.connected = true;
                    
                    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    this.socket.emit('register', { username: username });
                });
                
                this.socket.on('registered', (data) => {
                    console.log('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', data.username);
                    this.user = {
                        id: data.user_id,
                        username: data.username
                    };
                    this.rooms = data.rooms;
                    this.renderChat();
                    this.joinRoom('general');
                });
                
                this.socket.on('server_info', (data) => {
                    this.rooms = data.rooms;
                    this.updateRoomsList();
                    document.getElementById('onlineCount').textContent = data.total_users;
                });
                
                this.socket.on('room_history', (data) => {
                    if (data.room === this.currentRoom) {
                        this.displayMessages(data.messages);
                        document.getElementById('onlineCount').textContent = data.members;
                    }
                });
                
                this.socket.on('new_message', (data) => {
                    if (data.room === this.currentRoom) {
                        this.addMessage(data);
                    }
                });
                
                this.socket.on('rooms_updated', (data) => {
                    this.rooms = data.rooms;
                    this.updateRoomsList();
                });
                
                this.socket.on('user_joined', (data) => {
                    this.showNotification(`${data.username} Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©`);
                });
                
                this.socket.on('user_joined_room', (data) => {
                    if (data.room === this.currentRoom) {
                        this.showNotification(`${data.username} Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„ØºØ±ÙØ©`);
                        document.getElementById('onlineCount').textContent = data.members;
                    }
                });
                
                this.socket.on('user_left_room', (data) => {
                    if (data.room === this.currentRoom) {
                        this.showNotification(`${data.username} ØºØ§Ø¯Ø± Ø§Ù„ØºØ±ÙØ©`);
                        document.getElementById('onlineCount').textContent = data.members;
                    }
                });
                
                this.socket.on('error', (data) => {
                    alert(`âŒ Ø®Ø·Ø£: ${data.message}`);
                });
                
                this.socket.on('disconnect', () => {
                    console.log('âŒ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±Ú¤Ø±');
                    this.connected = false;
                    document.getElementById('userStatus').textContent = 'ğŸ”´ ØºÙŠØ± Ù…ØªØµÙ„';
                });
                
                this.socket.on('connect_error', (error) => {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', error);
                    alert('ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±Ú¤Ø±. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.');
                    this.renderLogin();
                });
            }
            
            joinRoom(roomId) {
                if (this.currentRoom !== roomId) {
                    this.currentRoom = roomId;
                    this.socket.emit('join_room', { room_id: roomId });
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    const roomName = this.rooms[roomId]?.name || roomId;
                    document.getElementById('currentRoom').textContent = `Ø§Ù„ØºØ±ÙØ©: ${roomName}`;
                    this.updateActiveRoom(roomId);
                }
            }
            
            updateRoomsList() {
                const roomsList = document.getElementById('roomsList');
                if (!roomsList) return;
                
                roomsList.innerHTML = '';
                
                for (const [roomId, roomData] of Object.entries(this.rooms)) {
                    const roomItem = document.createElement('div');
                    roomItem.className = `room-item ${roomId === this.currentRoom ? 'active' : ''}`;
                    roomItem.innerHTML = `
                        <span class="room-name">${roomData.name}</span>
                        <span class="room-members">${roomData.members}</span>
                    `;
                    roomItem.onclick = () => this.joinRoom(roomId);
                    roomsList.appendChild(roomItem);
                }
            }
            
            updateActiveRoom(roomId) {
                const roomItems = document.querySelectorAll('.room-item');
                roomItems.forEach(item => {
                    item.classList.remove('active');
                    if (item.querySelector('.room-name').textContent === this.rooms[roomId]?.name) {
                        item.classList.add('active');
                    }
                });
            }
            
            displayMessages(messages) {
                const container = document.getElementById('messagesContainer');
                container.innerHTML = '';
                
                messages.forEach(msg => {
                    this.addMessage(msg, false);
                });
                
                container.scrollTop = container.scrollHeight;
            }
            
            addMessage(data, scroll = true) {
                const container = document.getElementById('messagesContainer');
                
                // Ø¥Ø²Ø§Ù„Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
                const welcomeMsg = container.querySelector('.welcome-message');
                if (welcomeMsg) welcomeMsg.remove();
                
                const messageDiv = document.createElement('div');
                const isOwnMessage = data.sender_id === this.user?.id;
                messageDiv.className = `message ${isOwnMessage ? 'sent' : 'received'}`;
                
                const time = new Date(data.timestamp).toLocaleTimeString('ar-EG', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                messageDiv.innerHTML = `
                    <div class="message-sender">${data.sender}</div>
                    <div class="message-content">${data.message}</div>
                    <div class="message-time">${time}</div>
                `;
                
                container.appendChild(messageDiv);
                
                if (scroll) {
                    container.scrollTop = container.scrollHeight;
                }
            }
            
            showNotification(message) {
                console.log('ğŸ“¢', message);
                // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø© Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù‡Ù†Ø§
            }
            
            disconnect() {
                if (this.socket) {
                    this.socket.disconnect();
                }
                this.socket = null;
                this.user = null;
                this.connected = false;
            }
        }
        
        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const app = new ChatApp();
    </script>
</body>
</html>
